# Redis Storage для временного хранения черновиков

## Описание

Реализация временного хранения черновиков сайтов в Redis с поддержкой:
- TTL для каждого черновика
- Автоматическое удаление после истечения TTL
- Продление TTL при активности (чтение/обновление)

## Архитектура

### Структура ключей Redis

```
site-draft:{draftId}    # Основной ключ черновика (JSON)
```

### Формат данных

Черновик хранится как JSON строка в ключе `site-draft:{draftId}`:
- Все даты в ISO 8601 формате (строки)
- TTL устанавливается через `SETEX` команду
- При чтении/обновлении TTL продлевается через `EXPIRE`

## Операции

### 1. Создание черновика

**Процесс:**
1. Валидация входных данных
2. Генерация уникального ID (cuid2)
3. Создание объекта Draft с `expiresAt`
4. Сериализация в JSON
5. Сохранение в Redis с TTL через `SETEX`
6. Возврат созданного черновика

**TTL:**
- Вычисляется из `SITE_TTL_HOURS` (по умолчанию 24 часа)
- Устанавливается при создании через `SETEX`

**Пример:**
```typescript
const draft = await siteService.createDraft({
  brandName: "Моя Компания",
  industry: "tech"
});
// Черновик сохранен в Redis с TTL 24 часа
```

### 2. Чтение черновика

**Процесс:**
1. Получение данных из Redis по ключу `site-draft:{id}`
2. Проверка существования (если ключ не существует - TTL истек)
3. Десериализация JSON
4. Проверка `expiresAt` (дополнительная проверка)
5. Продление TTL через `EXPIRE` (если `REDIS_TTL_EXTEND_ON_READ=true`)
6. Обновление `expiresAt` в объекте для консистентности
7. Возврат черновика или null

**TTL продление:**
- При каждом чтении вызывается `EXPIRE` с новым TTL
- `expiresAt` в объекте обновляется для консистентности

**Пример:**
```typescript
const draft = await siteService.getDraft(draftId);
// TTL автоматически продлен на 24 часа
```

### 3. Обновление черновика

**Процесс:**
1. Получение существующего черновика
2. Проверка существования
3. Валидация обновлений
4. Слияние данных
5. Обновление `updatedAt`
6. Сериализация
7. Сохранение в Redis через `SETEX` (обновление значения и TTL)
8. Возврат обновленного черновика

**TTL продление:**
- При обновлении TTL продлевается через `SETEX`
- `expiresAt` обновляется в объекте

**Пример:**
```typescript
const updated = await siteService.updateDraft(draftId, {
  brandName: "Новое название"
});
// TTL автоматически продлен на 24 часа
```

### 4. Удаление черновика

**Процесс:**
1. Получение черновика (для проверки наличия логотипа)
2. Удаление связанных файлов (логотип)
3. Удаление ключа из Redis через `DEL`
4. Возврат результата

**Пример:**
```typescript
const deleted = await siteService.deleteDraft(draftId);
// Черновик и связанные файлы удалены
```

## Конфигурация

### Переменные окружения

```env
# Тип хранилища
STORAGE_TYPE=redis  # или 'memory' для fallback

# Redis подключение
REDIS_URL=redis://localhost:6379

# Продление TTL при чтении
REDIS_TTL_EXTEND_ON_READ=true

# TTL для черновиков (в часах)
SITE_TTL_HOURS=24
```

### Fallback на in-memory

Если Redis недоступен, сервис автоматически переключается на in-memory хранилище:
- Логируется предупреждение
- Сервис продолжает работать
- При следующем запуске попытается подключиться к Redis снова

## Особенности реализации

### Сериализация дат

Все объекты `Date` преобразуются в ISO 8601 строки при сохранении:
```typescript
{
  createdAt: "2024-01-15T10:00:00.000Z",
  updatedAt: "2024-01-15T10:30:00.000Z",
  expiresAt: "2024-01-16T10:00:00.000Z"
}
```

При чтении строки преобразуются обратно в объекты `Date`.

### Автоматическое удаление

Redis автоматически удаляет ключи с истекшим TTL:
- Не требуется дополнительная очистка
- Периодическая очистка (опционально) для валидации данных

### Продление TTL

TTL продлевается в двух случаях:
1. **При чтении** (если `REDIS_TTL_EXTEND_ON_READ=true`):
   - Вызывается `EXPIRE` с новым TTL
   - `expiresAt` обновляется в объекте

2. **При обновлении**:
   - Используется `SETEX` для обновления значения и TTL
   - `expiresAt` обновляется в объекте

## Мониторинг

### Логирование

Сервис логирует:
- Подключение к Redis
- Ошибки подключения
- Операции сохранения/чтения (debug уровень)
- Очистку истекших черновиков

### Метрики (будущее)

Можно добавить метрики:
- Количество активных черновиков
- Количество истекших черновиков
- Время выполнения операций
- Ошибки Redis

## Тестирование

### Локальное тестирование

1. Запустить Redis локально:
```bash
docker run -d -p 6379:6379 redis:latest
```

2. Установить переменные окружения:
```env
STORAGE_TYPE=redis
REDIS_URL=redis://localhost:6379
```

3. Запустить сервис:
```bash
pnpm dev
```

### Проверка работы

1. Создать черновик:
```bash
curl -X POST http://localhost:3001/api/drafts \
  -H "Content-Type: application/json" \
  -d '{"brandName":"Test","industry":"tech"}'
```

2. Проверить TTL в Redis:
```bash
redis-cli TTL site-draft:{draftId}
```

3. Прочитать черновик (TTL должен продлиться):
```bash
curl http://localhost:3001/api/drafts/{draftId}
```

4. Проверить TTL снова (должен быть обновлен):
```bash
redis-cli TTL site-draft:{draftId}
```

## Производительность

### Оптимизации

- Использование `SETEX` вместо `SET` + `EXPIRE` (одна команда)
- Пакетные операции для массовых операций (будущее)
- Кеширование подключения к Redis

### Ограничения

- Redis может стать узким местом при высокой нагрузке
- Рекомендуется использовать Redis Cluster для масштабирования
- Мониторинг памяти Redis

## Миграция с in-memory

Сервис автоматически определяет тип хранилища через `STORAGE_TYPE`:
- `redis` - использует Redis
- `memory` - использует in-memory (fallback)

Переключение происходит без изменения кода бизнес-логики.

